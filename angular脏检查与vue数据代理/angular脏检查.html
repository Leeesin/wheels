<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible"
        content="ie=edge">
  <title>Document</title>
</head>

<body>
  <div>
    <form>
      <input type="text"
             ng-bind="count" />
      <button type="button"
              ng-click="increment">increment</button>
    </form>
    <div ng-bind="count">
    </div>
  </div>
</body>
<script>
  class Component {
    constructor() {
      this.$$watchers = [];         //监听器
    }

    $watch(name, exp, listener) {
      this.$$watchers.push({
        name: name,                              //数据变量名
        last: '',                                //数据变量旧值
        newVal: exp,                             //返回数据变量新值的函数
        listener: listener || function () { }       //监听回调函数，变量“脏”时触发
      })
    }

    $digest() {
      var bindList = document.querySelectorAll("[ng-bind]");      //获取所有含ng-bind的DOM节点
      var dirty = true;
      while (dirty) {
        dirty = false;
        for (var i = 0; i < this.$$watchers.length; i++) {
          var newVal = this.$$watchers[i].newVal();
          var oldVal = this.$$watchers[i].last;

          if (newVal !== oldVal && !isNaN(newVal) && !isNaN(oldVal)) {
            dirty = true;
            this.$$watchers[i].listener(oldVal, newVal);
            this.$$watchers[i].last = newVal;
            for (var j = 0; j < bindList.length; j++) {
              //获取DOM上的数据变量的名称
              var modelName = bindList[j].getAttribute("ng-bind");
              //数据变量名相同的DOM才更新
              if (modelName == this.$$watchers[i].name) {
                if (bindList[j].tagName == "INPUT") {
                  //更新input的输入值
                  bindList[j].value = this[modelName];
                }
                else {
                  //更新非交互式DOM的值
                  bindList[j].innerHTML = this[modelName];
                }
              }
            }
          }
        }
      }
    }

    $render() {
      const ctx = this
      var bindList = document.querySelectorAll("[ng-click]");
      for (var i = 0; i < bindList.length; i++) {
        bindList[i].onclick = (function (index) {
          return function () {
            ctx[bindList[index].getAttribute("ng-click")]();
            ctx.$digest();           //调用函数时触发$digest
          }
        })(i)
      }

      var inputList = document.querySelectorAll("input[ng-bind]");
      for (var i = 0; i < inputList.length; i++) {
        inputList[i].addEventListener("input", (function (index) {
          return function () {
            ctx[inputList[index].getAttribute("ng-bind")] = inputList[index].value;
            ctx.$digest();           //调用函数时触发$digest
          }
        })(i));
      }

      //绑定数据
      for (var key in ctx) {
        if (key != "$$watchers" && typeof ctx[key] != "function") {            //非函数数据才进行绑定
          ctx.$watch(key, (function (index) {
            return function () {
              return ctx[index];
            }
          })(key))
        }
      }

      this.$digest();
    }
  }
</script>

<script>
  window.onload = function () {
    class HelloWorld extends Component {
      count = 0
      increment() {
        this.count++;
      }
    }
    var helloWorld = new HelloWorld()
    helloWorld.$render()
  };
</script>

</html>